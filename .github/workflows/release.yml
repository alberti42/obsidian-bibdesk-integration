name: Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

jobs:
  release:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Import signing certificate
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        run: |
          echo "$MACOS_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain -P "$MACOS_CERTIFICATE_PWD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          rm certificate.p12

      - name: Build plugin
        run: npm run build

      - name: Build bookmark resolver
        run: npm run bookmark_resolver

      - name: Prepare release notes
        run: |
          VERSION="${GITHUB_REF_NAME}"
          NOTES="release-notes/release_${VERSION}.md"
          if [ ! -f "$NOTES" ]; then
            echo "No release notes provided for version ${VERSION}." > "$NOTES"
          fi

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          body_path: release-notes/release_${{ github.ref_name }}.md
          files: |
            dist/bookmark_resolver
            dist/bookmark_resolver.scpt
            dist/main.js
            dist/manifest.json
            dist/styles.css
